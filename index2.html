<!DOCTYPE html>
<html>
<head>
    <title>A second lovely little test page!</title>
    <meta charset="utf-8">

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We"
          crossorigin="anonymous"
    >
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj"
            crossorigin="anonymous"
    ></script>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/reinvented-color-wheel@0.4.0/css/reinvented-color-wheel.min.css?1">
    <script src="https://cdn.jsdelivr.net/npm/reinvented-color-wheel@0.4.0"></script>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-center">
        <div id="headphones"></div>
    </div>

    <div id="imgcontainer" style="display: none"></div>
    <div class="row mt-5 mb-5">
        <div class="col-lg-6">
            <div class="row">
                <div class="col-0 col-lg-1"></div>
                <div class="col-6 col-lg-5">
                    <div class="d-flex justify-content-center">
                        <div id="colorWheel"></div>
                    </div>
                    <div class="text-center mt-3">
                        <h1><span id="hexDisplay" class="badge bg-secondary">Loading...</span></h1>
                    </div>
                </div>
                <div class="col-6 col-lg-5">
                    <div class="text-center mt-3">
                        <div class="btn-group-vertical" id="partSelector" role="group"
                             aria-label="Basic radio toggle button group">
                            <input type="radio" data-name="clamps" onclick="resetColorWheel('clamps');"
                                   class="btn-check"
                                   name="btnradio" id="btnradio1"
                                   autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="btnradio1">Clamps</label>

                            <input type="radio" data-name="coneCenters" onclick="resetColorWheel('coneCenters');"
                                   class="btn-check" name="btnradio" id="btnradio2"
                                   autocomplete="off">
                            <label class="btn btn-outline-primary" for="btnradio2">Cone Centers</label>

                            <input type="radio" data-name="cones" onclick="resetColorWheel('cones');" class="btn-check"
                                   name="btnradio" id="btnradio3"
                                   autocomplete="off">
                            <label class="btn btn-outline-primary" for="btnradio3">Cones</label>

                            <input type="radio" data-name="covers" onclick="resetColorWheel('covers');"
                                   class="btn-check"
                                   name="btnradio" id="btnradio4"
                                   autocomplete="off">
                            <label class="btn btn-outline-primary" for="btnradio4">Covers</label>

                            <input type="radio" data-name="earpads" onclick="resetColorWheel('earpads');"
                                   class="btn-check"
                                   name="btnradio" id="btnradio5"
                                   autocomplete="off">
                            <label class="btn btn-outline-primary" for="btnradio5">Earpads</label>

                            <input type="radio" data-name="headband" onclick="resetColorWheel('headband');"
                                   class="btn-check"
                                   name="btnradio" id="btnradio6"
                                   autocomplete="off">
                            <label class="btn btn-outline-primary" for="btnradio6">Headband</label>

                            <input type="radio" data-name="spring" onclick="resetColorWheel('spring');"
                                   class="btn-check"
                                   name="btnradio" id="btnradio7"
                                   autocomplete="off">
                            <label class="btn btn-outline-primary" for="btnradio7">Spring</label>
                        </div>
                    </div>
                </div>
                <div class="col-0 col-lg-1"></div>
            </div>
            <div class="row mt-3">
                <div class="col-0 col-md-2"></div>
                <div class="col-12 col-md-8">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="downloadCanvas();" type="button">Download Image
                        </button>
                    </div>
                </div>
                <div class="col-0 col-md-2"></div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="text-center">
                <h2>Wanna make this for real? <span class="btn btn-primary" onclick="refreshTable();">Click here to refresh the table!</span>
                </h2>
                Here's what you'll need! Keep in mind that you'll need to use PETG or ABS for best results. Powered by
                <a href="https://filamentcolors.xyz" target="_blank">Filamentcolors.xyz!</a>
            </div>
            <div id="filamentTableLoadingScreen" class="position-relative">
                <img id="spinner" src="images/swatch-loading-animation-try10.gif" class="position-absolute"
                     style="left: 50%;transform: translate(-50%); display:none; z-index: 10">
                <table id="filamentTable" class="table table-bordered mt-3 position-relative">
                    <thead>
                    <tr>
                        <th scope="col">Part</th>
                        <th scope="col">Filament</th>
                        <th scope="col">Color</th>
                        <th scope="col"></th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr id="clampsRow">
                        <th scope="row">Clamps</th>
                        <td>Unknown</td>
                        <td></td>
                        <td><a href="#" target="_blank" class="btn btn-secondary btn-sm disabled">Buy here!</a></td>
                    </tr>
                    <tr id="coneCentersRow">
                        <th scope="row">Cone Centers</th>
                        <td>Unknown</td>
                        <td></td>
                        <td><a href="#" target="_blank" class="btn btn-secondary btn-sm disabled">Buy here!</a></td>
                    </tr>
                    <tr id="conesRow">
                        <th scope="row">Cones</th>
                        <td>Unknown</td>
                        <td></td>
                        <td><a href="#" target="_blank" class="btn btn-secondary btn-sm disabled">Buy here!</a></td>
                    </tr>
                    <tr id="coversRow">
                        <th scope="row">Covers</th>
                        <td>Unknown</td>
                        <td></td>
                        <td><a href="#" target="_blank" class="btn btn-secondary btn-sm disabled">Buy here!</a></td>
                    </tr>
                    <tr id="earpadsRow">
                        <th scope="row">Earpads</th>
                        <td>Not Printable</td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr id="headbandRow">
                        <th scope="row">Headband</th>
                        <td>Not Printable</td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr id="springRow">
                        <th scope="row">Spring</th>
                        <td>Unknown</td>
                        <td></td>
                        <td><a href="#" target="_blank" class="btn btn-secondary btn-sm disabled">Buy here!</a></td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="text-center">
                <a href="https://filamentcolors.xyz/library/collection/95,327,331,1035,899,1079" id="collectionButton" class="btn btn-primary">Save Filament Collection</a>
            </div>
            <div class="text-center mt-2">
                <span class="text-muted">Buy links use Amazon Affliate links when available.</span>
            </div>

        </div>
    </div>
</div>

<script>
    // The way that this works is by taking an image on the page, grabbing its content,
    // and mirroring it to a layered canvas. We have eight layers, of which seven are
    // modifiable. The overall goal is to change the color of an arbitrary layer
    // by way of a color selector.
    //
    // This script has two distinct parts: the setup and usage.
    // Setup:
    // * Iterate through the data object and create images under the hidden "imgcontainer"
    // * Iterate through the data object and create canvases for each layer
    // * Assign each layer a zIndex to make sure that they all show above the background
    //   * Note: just creating the canvas doesn't show the image; we have to draw the image
    //       onto the canvas in the next step.
    // * Iterate through the data object and draw each layer
    //
    // When drawing the layer, we grab the canvas, grab the image data, set all the
    // non-transparent pixels to the target RGB color, and then write the pixel data to the
    // canvas. We only need to draw the layer once - after the first time, we can just take
    // the information that's already there, modify it, and write it back.
    //
    // The second part is usage. The most difficult part of using the system is identifying
    // which layer we're supposed to be modifying, which we do with radio buttons (taking
    // advantage of the fact that only one can be selected at any given time). When the
    // color picker is moved, we do a check on the radio buttons to see which one is
    // selected. That radio button has a custom property (data-name) which matches the key
    // of the layer in the data object. We:
    // * grab the property from the radio button
    // * look up the layer in the data object
    // * set the layer's RGB color to the current RGB value of the color picker
    // * grab the canvas
    // * load all the pixel data from that canvas
    // * iterate through the pixels, skipping all transparent ones, and set the color of the
    //     pixel to the RGB color stored in the data object
    // * write the pixel data to the canvas
    //
    // The last part is just a bit of fakery to make it a little more usable and look better.
    // Each radio button has an onclick event that sets the color picker to the last known
    // color for that layer when the button is selected, and we have to kickstart the picker
    // with the current value of the first layer (the clamps) so that it will look right on
    // page load.
    //
    // The biggest deficit of this approach is that the images are statically sized because
    // of the canvas. I haven't yet identified how to scale them, but the Mozilla documentation
    // recommends not scaling canvases when writing due to performance concerns. It seems like
    // we might want to extend the data object to link to different sizes of images so that
    // there can be a mobile version, a tablet version, and a desktop version (or something
    // along those lines). Either way, it's a good start!

    let data = {
        'download': {
            'canvas': 'downloadCanvas',
            'zIndex': -1
        },
        'background': {
            'img': 'imgBase',
            'src': 'images/base_small.png',
            'canvas': 'canvasBackground',
            'zIndex': 0
        },
        'clamps': {
            'img': 'imgClamps',
            'src': 'images/clamps_small.png',
            'canvas': 'canvasClamps',
            'color': [0, 94, 157],
            'zIndex': 1,
            'isPrintable': true,
            'material': 'petg',
        },
        'coneCenters': {
            'img': 'imgConeCenters',
            'src': 'images/cone_centers_small.png',
            'canvas': 'canvasConeCenters',
            'color': [255, 50, 206],
            'zIndex': 2,
            'isPrintable': true,
            'material': 'any'
        },
        'cones': {
            'img': 'imgCones',
            'src': 'images/cones_small.png',
            'canvas': 'canvasCones',
            'color': [58, 186, 255],
            'zIndex': 3,
            'isPrintable': true,
            'material': 'pla',
        },
        'covers': {
            'img': 'imgCovers',
            'src': 'images/covers_small.png',
            'canvas': 'canvasCovers',
            'color': [10, 10, 10],
            'zIndex': 4,
            'isPrintable': true,
            'material': 'any',
        },
        'earpads': {
            'img': 'imgEarpads',
            'src': 'images/earpads_small.png',
            'canvas': 'canvasEarpads',
            'color': [10, 10, 10],
            'zIndex': 5,
            'isPrintable': false
        },
        'headband': {
            'img': 'imgHeadband',
            'src': 'images/headband_small.png',
            'canvas': 'canvasHeadband',
            'color': [88, 88, 88],
            'zIndex': 6,
            'isPrintable': false,
        },
        'spring': {
            'img': 'imgSpring',
            'src': 'images/spring_small.png',
            'canvas': 'canvasSpring',
            'color': [255, 244, 104],
            'zIndex': 7,
            'isPrintable': true,
            'material': 'petg',
        }
    }

    pageDefaultData = {
        '0a0a0a': {
            'color_name': 'Black',
            'hex_color': '0B0B0B',
            'amazon_purchase_link': 'https://www.amazon.com/gp/product/B07YG7R49Z/ref=as_li_qf_asin_il_tl?ie=UTF8&tag=filamentcol0c-20&creative=9325&linkCode=as2&creativeASIN=B07YG7R49Z&linkId=2cedc029d56d96edeb978936d2e1a65b',
            'manufacturer': {
                'name': 'GreenGate3D'
            },
            'filament_type': {
                'name': 'PETG'
            },
        },
        '3abaff': {
            'color_name': 'Silk Blue',
            'hex_color': '47B9FC',
            'amazon_purchase_link': 'https://amzn.to/2mBzqSK',
            'manufacturer': {
                'name': 'Mika3D'
            },
            'filament_type': {
                'name': 'PLA'
            },
        },
        '005e9d': {
            'color_name': 'Cadet Blue',
            'hex_color': '3E64A4',
            'amazon_purchase_link': 'https://amzn.to/2LIBD9m',
            'manufacturer': {
                'name': 'Paramount 3D'
            },
            'filament_type': {
                'name': 'PLA'
            },
        },
        'ff32ce': {
            'color_name': 'Island Fuchsia',
            'hex_color': 'E426A8',
            'amazon_purchase_link': null,
            'mfr_purchase_link': 'https://www.3dfuel.com/products/ingeo-pla-island-fuchsia',
            'manufacturer': {
                'name': '3D-Fuel'
            },
            'filament_type': {
                'name': 'PLA'
            },
        },
        'fff468': {
            'color_name': 'Silk Yellow',
            'hex_color': 'FDEF6B',
            'amazon_purchase_link': 'https://amzn.to/2kGu08r',
            'manufacturer': {
                'name': 'Mika3D'
            },
            'filament_type': {
                'name': 'PLA'
            },
        },
    }

    // The API needs hex, but we deal pretty much exclusively here with RGB. We'll convert
    // before we send out, then convert back to RGB when we get a response back.
    // https://stackoverflow.com/a/39077686
    const rgbToHex = (r, g, b) => [r, g, b].map(x => {
        const hex = x.toString(16)
        return hex.length === 1 ? '0' + hex : hex
    }).join('')

    const hexToRgb = hex =>
        hex.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i
            , (m, r, g, b) => '#' + r + r + g + g + b + b)
            .substring(1).match(/.{2}/g)
            .map(x => parseInt(x, 16))

    function updateFilamentTable(respData) {
        for (const [key, value] of Object.entries(respData)) {
            let color = hexToRgb("#" + key)
            for (layer in data) {
                if (data[layer].hasOwnProperty('color') === true && data[layer]['isPrintable'] === true) {
                    // the fact that JS can't compare arrays by default is RIDICULOUS
                    if (JSON.stringify(color) === JSON.stringify(data[layer]['color'])) {
                        tableRow = document.getElementById(`${layer}Row`);
                        filamentCell = tableRow.children[1];
                        filamentColorCell = tableRow.children[2];
                        buyButton = tableRow.children[3].children[0];

                        filamentCell.innerHTML = `${value['manufacturer']['name']} ${value['color_name']} ${value['filament_type']['name']}`;
                        filamentColorCell.style.backgroundColor = `#${value["hex_color"]}`;
                        if (value['amazon_purchase_link']) {
                            buyButton.classList.remove('disabled');
                            buyButton.classList.remove('btn-secondary');
                            buyButton.classList.add('btn-primary');
                            buyButton.href = value['amazon_purchase_link'];
                        } else if (value['mfr_purchase_link']) {
                            buyButton.classList.remove('disabled');
                            buyButton.classList.remove('btn-secondary');
                            buyButton.classList.add('btn-primary');
                            buyButton.href = value['mfr_purchase_link'];
                        } else {
                            // We don't have any buy links for it.
                            buyButton.classList.add('disabled');
                            buyButton.classList.remove('btn-primary');
                            buyButton.classList.add('btn-secondary');
                        }
                    }
                }
            }
        }
        filamentTable.style.backgroundColor = "white";
        filamentTable.style.opacity = 100;
        spinner.style.display = "none";
    }

    function updateCollectionButton(respData) {
        console.log(respData);
        const ids = [];
        for (const [key, value] of Object.entries(respData)) {
            ids.push(value.id);
            console.log(value.id)
        }
        document.getElementById("collectionButton").href = `https://filamentcolors.xyz/library/collection/${ids.join(",")}`;
    }

    function refreshTable() {
        // TODO: Ways to improve this function:
        //
        // * cache the time that a specific color was requested vs when the
        //     button was pressed -- only request colors that have changed
        //     since the button was last pressed
        // * start with the colors of the predefined palette already built
        //     so that the site doesn't have to handle the same palette over
        //     and over

        filamentTable = document.getElementById('filamentTable');
        spinner = document.getElementById("spinner");
        filamentTable.style.backgroundColor = "lightgray";
        filamentTable.style.opacity = "40%";
        spinner.style.display = null;

        let colors = [];
        let materials = [];
        for (key in data) {
            if (data[key].hasOwnProperty('color')) {
                colors.push(rgbToHex(...data[key]['color']))
            }
            if (data[key].hasOwnProperty('material')) {
                materials.push(data[key]['material'])
            } else {
                materials.push("any")
            }
        }

        fetch(`https://filamentcolors.xyz/api/swatch/bulk_colormatch/?colors=${colors.join(",")}&materials=${materials.join(",")}`)
            .then(response => response.json())
            .then(respData => {
                updateCollectionButton(respData);
                updateFilamentTable(respData);
            });
    }

    function downloadCanvas() {
        let canvases = []
        for (const [key, value] of Object.entries(data)) {
            canvases.push(getcanvas(key))
        }
        downloadcanvas = canvases.shift()  // remove and store first canvas
        downloadctx = downloadcanvas.getContext("2d")
        canvases.forEach(canvas => downloadctx.drawImage(canvas, 0, 0));
        const link = document.createElement('a');
        link.download = "custom_headphones.png";
        link.href = downloadcanvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
        link.click()
    }

    function getcanvas(layerId) {
        return document.getElementById(data[layerId]['canvas'])
    }

    function getctx(layerId) {
        return getcanvas(layerId).getContext("2d")
    }

    function updateImage(layerId) {
        if (layerId === 'background') {
            return
        }
        let ctx = getctx(layerId)
        let imgd = ctx.getImageData(0, 0, 697, 697);
        let pix = imgd.data;
        // Loop through all the pixels and set the new color.
        for (var i = 0, n = pix.length; i < n; i += 4) {
            // only modify pixels that are not transparent
            if (pix[i + 3] !== 0) {
                pix[i] = data[layerId]['color'][0]
                pix[i + 1] = data[layerId]['color'][1]
                pix[i + 2] = data[layerId]['color'][2]
                //pix[i+3] is the transparency.
            }
        }
        ctx.putImageData(imgd, 0, 0);
    }

    function draw(layerId) {
        let ctx = getctx(layerId)
        let img = document.getElementById(data[layerId]["img"])
        ctx.drawImage(img, 0, 0);
        updateImage(layerId)
    }

    function resetColorWheel(layerId) {
        colorWheel.rgb = data[layerId]['color'];
        colorWheel.redraw()
    }

    const imgContainer = document.getElementById('imgcontainer')
    const canvasContainer = document.getElementById('headphones')
    for (const [key, value] of Object.entries(data)) {
        if (value['img']) {
            imgEl = document.createElement('img')
            imgEl.setAttribute('src', value['src'])
            imgEl.setAttribute('id', value['img'])
            imgContainer.appendChild(imgEl)
        }

        canvasEl = document.createElement('canvas');
        canvasEl.setAttribute('width', 697);
        canvasEl.setAttribute('height', 697);
        canvasEl.setAttribute('id', value['canvas'])
        canvasEl.style.zIndex = value['zIndex']
        canvasContainer.appendChild(canvasEl);
    }

    const hexDisplay = document.getElementById('hexDisplay')
    const partOptions = document.getElementsByClassName('btn-check')
    window.addEventListener('load', function () {
        for (const [key, value] of Object.entries(data)) {
            if (value['img']) {
                draw(key)
            }
        }
        colorWheel = new ReinventedColorWheel({
            // appendTo is the only required property. specify the parent element of the color wheel.
            appendTo: document.getElementById("colorWheel"),

            // followings are optional properties and their default values.
            rgb: [255, 0, 0],

            // appearance
            wheelDiameter: 200,
            wheelThickness: 26,
            handleDiameter: 20,
            wheelReflectsSaturation: true,

            // handler
            onChange: function (color) {
                hexDisplay.innerText = color.hex
                for (var i = 0, length = partOptions.length; i < length; i++) {
                    if (partOptions[i].checked) {
                        // do whatever you want with the checked radio
                        let layer = partOptions[i].getAttribute('data-name')
                        data[layer]['color'] = color.rgb;
                        updateImage(layer)
                        // only one radio can be logically checked, don't check the rest
                        break;
                    }
                }
            },
        });
        // force the color wheel to the default checkbox
        resetColorWheel('clamps');
        updateFilamentTable(pageDefaultData);
    });

</script>


<style>
    #headphones {
        width: 697px;
        height: 697px;
    }

    #headphones canvas {
        position: absolute;
    }
</style>

</body>
</html>
